#
# This file defines Route53 records, including ones needed for orchestrations

<%
records = CONFIG.fetch('route53', [])

CONFIG.fetch('orchestrations', []).each_with_index do |orchestration,index|
  if orchestration['type'] === 'static-website'
    record = {
      'zone'  => orchestration['zone'],
      'name'  => orchestration['name'],
      'alias' => orchestration['name']
    }

    records << record.merge({'type' => 'A'})
    records << record.merge({'type' => 'AAAA'})
  end
end

zones = records.map { |record| record['zone'] }
zones.uniq!
%>

#
# Get Route53 zone data
###############################################################################

<% zones.each do |zone|  %>
  # https://www.terraform.io/docs/providers/aws/d/route53_zone.html
  data "aws_route53_zone" "<%= zone.resourceify %>" {
    name = "<%= zone %>"
  }
<% end %>

#
# Create Route53 records
###############################################################################

<% records.each_with_index do |record,index| %>
  # https://www.terraform.io/docs/providers/aws/r/route53_record.html
  resource "aws_route53_record" "<%= "#{record['name']}-#{record['type']}".resourceify %>" {
    zone_id = "${data.aws_route53_zone.<%= record['zone'].resourceify %>.zone_id}"
    name    = "<%= record['name'] %>"
    type    = "<%= record['type'] %>"

    <% unless record['records'].nil? %>
      records = ["<%= record['records'].join('","') %>"]
    <% end %>

    <% unless record['alias'].nil? %>
      <% zone_alias = "aws_cloudfront_distribution.#{record['alias'].resourceify}" %>

      # https://www.terraform.io/docs/providers/aws/r/route53_record.html
      alias {
        zone_id = "${<%= zone_alias %>.hosted_zone_id}"
        name    = "${<%= zone_alias %>.domain_name}"

        evaluate_target_health = false
      }
    <% end %>
  }
<% end %>
